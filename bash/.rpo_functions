#!/usr/bin/bash

strip() {
    local var="$1"
    var="${var#"${var%%[![:space:]]*}"}"
    var="${var%"${var##*[![:space:]]}"}"
    printf '%s' "$var"
}

smite() {
    local command_number
    local command_to_delete

    set -o pipefail
    shopt -s lastpipe

    if [[ -n $1 ]]; then
        echo "usage: smite [-a]" >&2
        return 1
    fi

    local selected_lines
    mapfile -t selected_lines < <(fc -l 1 | fzf --no-sort --tac --multi)

    for (( i=${#selected_lines[@]}-1 ; i>=0 ; i-- )); do
        local line="${selected_lines[i]}"
        command_number=$(strip "${line%%[[:space:]]*}")
        command_to_delete=$(strip "${line#*[[:space:]]}")
        echo "Removing history entry: ${command_to_delete} (command number: ${command_number})"
        history -d "$command_number"
    done

    history -w
}

dedup() {
    # Implement similar deduplication rules as this setting:
    # HISTIGNORE="la:ll:ls:ls *:cd:cd *:pwd:exit:clear:history:h:which *"
    cp "${HOME}/.bash_history" "${HOME}/.bash_history.backup" \
       && awk '!seen[$0]++' "${HOME}/.bash_history.backup" \
              | sed \
                    -e '/^la\([[:space:]].\+\|\)$/d' \
                    -e '/^ll\([[:space:]].\+\|\)$/d' \
                    -e '/^ls\([[:space:]].\+\|\)$/d' \
                    -e '/^cd\([[:space:]].\+\|\)$/d' \
                    -e '/^pwd$/d' \
                    -e '/^history$/d' \
                        > "${HOME}/.bash_history"
}

apurge() {
    # shellcheck disable=SC2046
    sudo apt purge $(dpkg -l | grep ^rc | awk '{ print $2 }' | xargs)
}

aupgrade() {
    local instr
    instr="${1}"

    case "${instr}" in
        plan)   sudo apt update && TERM=xterm-256color sudo apt list --upgradable; return 0 ;;
        apply)  sudo apt -yy full-upgrade ;;
        *)      >&2 echo "Unknown command. Usage: aupgrade <plan | apply>"; return 1 ;;
    esac
    sudo apt clean
    sudo apt autoremove
    apurge
}
